local Services, Utility = LoadModule("core/Services.lua"), LoadModule("core/Utility.lua")

local Workspace = Utility.GetService("Workspace")
local RunService = Services.RunService
local ReplicatedStorage = Services.ReplicatedStorage

local Heartbeat = Utility.index(RunService, "Heartbeat")
local GetChildren = Utility.GetChildren
local FindFirstChild = Utility.FindFirstChild

local Player = Utility.GetPlayer()
local RemoteEvents = FindFirstChild(ReplicatedStorage, "RemoteEvents")
local CollectGrowable = FindFirstChild(RemoteEvents, "CollectGrowable")
local Tycoons = FindFirstChild(Workspace, "Tycoons")
local Growables = FindFirstChild(Workspace, "Growables")
local AllDrops = FindFirstChild(Workspace, "AllDrops")

local Exploits = {
	Flags = {
		InstantOres = false,
		InstantOreSettings = {
			TeleportToUpgraders = false,
			Mode = "Touch",
		},
		GrowableAura = false,
	},

	InstantOres = {
		Connections = {},
		LastCache = 0,
		UpgraderCFrames = {},
	},

	GrowableAura = {
		Connections = {},
	},
}

function Exploits.GrowableAura:Start()
	local function CollectAll()
		if not Exploits.Flags.GrowableAura then
			return
		end

		for _, growable in pairs(Growables:GetChildren()) do
			CollectGrowable:FireServer(growable)
		end
	end

	local HeartbeatConnection = Heartbeat:Connect(CollectAll)
	table.insert(self.Connections, HeartbeatConnection)
end

function Exploits.GrowableAura:Stop()
	for _, connection in pairs(self.Connections) do
		connection:Disconnect()
		connection = nil
	end
end

function Exploits.InstantOres:Runtime(OurTycoonID)
	if not Exploits.Flags.InstantOres then
		return
	end

	sethiddenproperty(Player, "SimulationRadius", math.huge)

	local OurTycoon = FindFirstChild(Tycoons, tostring(OurTycoonID))
	if not OurTycoon then
		return
	end

	local PurchaseableModels = FindFirstChild(OurTycoon, "PurchaseableModels")
	if not PurchaseableModels then
		return
	end

	local Conveyor = FindFirstChild(PurchaseableModels, "1")
	if not Conveyor or not Conveyor:FindFirstChild("TycoonCollector") then
		return
	end

	local Now = tick()
	if Now - self.LastCache >= 5 then
		self.UpgraderCFrames = {}
		for _, model in pairs(GetChildren(PurchaseableModels)) do
			local Part = FindFirstChild(model, "Upgrader")
			if Part then
				self.UpgraderCFrames[Part] = Part.CFrame
			end
		end

		self.LastCache = Now
	end

	for _, ore in pairs(GetChildren(AllDrops)) do
		local OwnerTag = FindFirstChild(ore, "OwnerTag")
		if OwnerTag and OwnerTag.Value == Player and ore.PrimaryPart then
			pcall(function()
				ore.PrimaryPart.CustomPhysicalProperties = PhysicalProperties.new(0, 0, 0, 0, 0)
				if Exploits.Flags.InstantOreSettings.TeleportToUpgraders then
					for part, cf in ipairs(self.UpgraderCFrames) do
						if Exploits.Flags.InstantOreSettings.Mode == "Pivot" then
							ore:PivotTo(cf)
						else
							firetouchinterest(ore.PrimaryPart, part, true)
							firetouchinterest(ore.PrimaryPart, part, false)
						end
					end
				end

				ore:PivotTo(Conveyor.TycoonCollector.CFrame)
			end)
		end
	end
end

function Exploits.InstantOres:Start()
	local OurTycoonID = Player:GetAttribute("TycoonID")
	local HeartbeatConnection = Heartbeat:Connect(function()
		self:Runtime(OurTycoonID)
	end)

	table.insert(self.Connections, HeartbeatConnection)
end

function Exploits.InstantOres:Stop()
	for _, connection in pairs(self.Connections) do
		connection:Disconnect()
		connection = nil
	end
end

function Exploits:Start()
	for _, Feature in pairs(self) do
		if type(Feature) == "function" then
			continue
		end

		if Feature ~= self.Flags then
			Feature:Start()
		end
	end
end

function Exploits:Stop()
	for _, Feature in pairs(self) do
		if type(Feature) == "function" then
			continue
		end

		if Feature ~= self.Flags then
			Feature:Stop()
		end
	end
end

return Exploits
