local Services, Utility = LoadModule("core/Services.lua"), LoadModule("core/Utility.lua")

local Workspace = Utility.GetService("Workspace")
local RunService = Services.RunService
local ReplicatedStorage = Services.ReplicatedStorage

local Heartbeat = Utility.index(RunService, "Heartbeat")
local GetChildren = Utility.GetChildren
local FindFirstChild = Utility.FindFirstChild

local Player = Utility.GetPlayer()
local RemoteEvents = FindFirstChild(ReplicatedStorage, "RemoteEvents")
local CollectGrowable = FindFirstChild(RemoteEvents, "CollectGrowable")
local Tycoons = FindFirstChild(Workspace, "Tycoons")
local Growables = FindFirstChild(Workspace, "Growables")
local AllDrops = FindFirstChild(Workspace, "AllDrops")

local Exploits = {
	Flags = {
		InstantOres = false,
		GrowableAura = false,
	},

	InstantOres = {
		Connections = {},
	},

	GrowableAura = {
		Connections = {},
	},
}

function Exploits.GrowableAura:Start()
	local function CollectAll()
		if not Exploits.Flags.GrowableAura then
			return
		end

		for _, growable in pairs(Growables:GetChildren()) do
			CollectGrowable:FireServer(growable)
		end
	end

	local HeartbeatConnection = Heartbeat:Connect(CollectAll)
	table.insert(self.Connections, HeartbeatConnection)
end

function Exploits.GrowableAura:Stop()
	for _, connection in pairs(self.Connections) do
		connection:Disconnect()
		connection = nil
	end
end

function Exploits.InstantOres:Runtime(OurTycoonID)
	if not Exploits.Flags.InstantOres then
		return
	end

	sethiddenproperty(Player, "SimulationRadius", math.huge)
	local OurTycoon = FindFirstChild(Tycoons, tostring(OurTycoonID))
	if not OurTycoon then
		return
	end
	local PurchaseableModels = FindFirstChild(OurTycoon, "PurchaseableModels")
	if not PurchaseableModels then
		return
	end
	local Conveyor = FindFirstChild(PurchaseableModels, "1")
	if not Conveyor then
		return
	end

	for _, ore in pairs(GetChildren(AllDrops)) do
		local OwnerTag = FindFirstChild(ore, "OwnerTag")
		if not OwnerTag then
			continue
		end

		if OwnerTag.Value == Player then
			pcall(function(...)
				ore.PrimaryPart.CustomPhysicalProperties = PhysicalProperties.new(0, 0, 0, 0, 0)
				ore:PivotTo(Conveyor.TycoonCollector.CFrame)
			end)
		end
	end
end

function Exploits.InstantOres:Start()
	local OurTycoonID = Player:GetAttribute("TycoonID")
	local HeartbeatConnection = Heartbeat:Connect(function()
		self:Runtime(OurTycoonID)
	end)

	table.insert(self.Connections, HeartbeatConnection)
end

function Exploits.InstantOres:Stop()
	for _, connection in pairs(self.Connections) do
		connection:Disconnect()
		connection = nil
	end
end

function Exploits:Start()
	for _, Feature in pairs(self) do
		if type(Feature) == "function" then
			continue
		end

		if Feature ~= self.Flags then
			Feature:Start()
		end
	end
end

function Exploits:Stop()
	for _, Feature in pairs(self) do
		if type(Feature) == "function" then
			continue
		end

		if Feature ~= self.Flags then
			Feature:Stop()
		end
	end
end

return Exploits
